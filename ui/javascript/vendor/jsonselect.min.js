(function(a){function q(a){return{sel:j(a)[1],match:function(a){return p(this.sel,a)},forEach:function(a,b){return o(this.sel,a,b)}}}function p(a,b){var c=[];o(a,b,function(a){c.push(a)});return c}function o(a,b,c,d,e,f){var g=a[0]===","?a.slice(1):[a],h=[],i=!1,j=0,k=0,m,p;for(j=0;j<g.length;j++){p=n(b,g[j],d,e,f),p[0]&&(i=!0);for(k=0;k<p[1].length;k++)h.push(p[1][k])}if(h.length&&typeof b=="object"){h.length>=1&&h.unshift(",");if(l(b))for(j=0;j<b.length;j++)o(h,b[j],c,undefined,j,b.length);else for(m in b)b.hasOwnProperty(m)&&o(h,b[m],c,m)}i&&c&&c(b)}function n(a,b,c,d,e){var f=[],g=b[0]===">"?b[1]:b[0],h=!0,i;g.type&&(h=h&&g.type===m(a)),g.id&&(h=h&&g.id===c),h&&g.pf&&(g.pf===":nth-last-child"?d=e-d:d++,g.a===0?h=g.b===d:(i=(d-g.b)%g.a,h=!i&&d*g.a+g.b>=0));if(h&&g.has){var j=function(){throw 42};for(var k=0;k<g.has.length;k++){try{o(g.has[k],a,j)}catch(l){if(l===42)continue}h=!1;break}}b[0]!==">"&&b[0].pc!==":root"&&f.push(b),h&&(b[0]===">"?b.length>2&&(h=!1,f.push(b.slice(2))):b.length>1&&(h=!1,f.push(b.slice(1))));return[h,f]}function m(a){if(a===null)return"null";var b=typeof a;b==="object"&&l(a)&&(b="array");return b}function l(a){return Array.isArray?Array.isArray(a):b.call(a)==="[object Array]"}function e(a){throw new Error(d[a])}function c(a){try{if(JSON&&JSON.parse)return JSON.parse(a);return(new Function("return "+a))()}catch(b){e("ijs")}}var b=Object.prototype.toString,d={ijs:"invalid json string",mcp:"missing closing paren",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ucp:"unexpected closing paren",ujs:"unclosed json string",upc:"unrecognized pseudo class",pex:"opening paren expected '('"},f={psc:1,psf:2,typ:3,str:4},g=/^(?:([\r\n\t\ ]+)|([*.,>\)\(])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child|has))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,h=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,i=function(a,b){b||(b=0);var d=g.exec(a.substr(b));if(!d)return undefined;b+=d[0].length;var h;d[1]?h=[b," "]:d[2]?h=[b,d[0]]:d[3]?h=[b,f.typ,d[0]]:d[4]?h=[b,f.psc,d[0]]:d[5]?h=[b,f.psf,d[0]]:d[6]?e("upc"):d[7]?h=[b,f.str,c(d[0])]:d[8]?e("ujs"):d[9]&&(h=[b,f.str,d[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]);return h},j=function(a,b,c){var d=[],f,g;b||(b=0);for(;;){var h=k(a,b);d.push(h[1]),h=i(a,b=h[0]),h&&h[1]===" "&&(h=i(a,b=h[0]));if(!h)break;if(h[1]===">")d.push(">"),b=h[0];else if(h[1]===",")f===undefined?f=[",",d]:f.push(d),d=[],b=h[0];else if(h[1]===")"){c||e("ucp"),g=1,b=h[0];break}}c&&!g&&e("mcp"),f&&f.push(d);return[b,f?f:d]},k=function(a,b){var c=b,d={},g=i(a,b);g&&g[1]===" "&&(c=b=g[0],g=i(a,b)),g&&g[1]===f.typ?(d.type=g[2],g=i(a,b=g[0])):g&&g[1]==="*"&&(g=i(a,b=g[0]));for(;;){if(g===undefined)break;if(g[1]===".")g=i(a,b=g[0]),(!g||g[1]!==f.str)&&e("sra"),d.id&&e("nmi"),d.id=g[2];else if(g[1]===f.psc)(d.pc||d.pf)&&e("mpc"),g[2]===":first-child"?(d.pf=":nth-child",d.a=0,d.b=1):g[2]===":last-child"?(d.pf=":nth-last-child",d.a=0,d.b=1):d.pc=g[2];else{if(g[1]!==f.psf)break;if(g[2]===":has"){g=i(a,b=g[0]),g&&g[1]===" "&&(g=i(a,b=g[0])),(!g||g[1]!=="(")&&e("pex");var k=j(a,g[0],!0);g[0]=k[0],d.has||(d.has=[]),d.has.push(k[1])}else{(d.pc||d.pf)&&e("mpc"),d.pf=g[2];var l=h.exec(a.substr(g[0]));l||e("mepf"),l[5]?(d.a=2,d.b=l[5]==="odd"?1:0):l[6]?(d.a=0,d.b=parseInt(l[6],10)):(d.a=parseInt((l[1]?l[1]:"+")+(l[2]?l[2]:"1"),10),d.b=l[3]?parseInt(l[3]+l[4],10):0),g[0]+=l[0].length}}g=i(a,b=g[0])}c===b&&e("se");return[b,d]};a._lex=i,a._parse=j,a.match=function(a,b){return q(a).match(b)},a.forEach=function(a,b,c){return q(a).forEach(b,c)},a.compile=q})(typeof exports=="undefined"?window.JSONSelect={}:exports)